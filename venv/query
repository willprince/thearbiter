with a as(
select idPair, idEx as idEx1, max(closing) as max
from pricedata
group by idPair
),

b as(
select idPair, idEx as idEx2, min(closing) as min
from pricedata
group by idPair
)

select *, (max-min) as dif, ((max/min)-1)*100 as marge
from a join b using(idPair)
ORDER BY marge desc
